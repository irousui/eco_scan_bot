from aiogram import F, Router
from aiogram.types import Message, InputFile
from aiogram.filters import CommandStart, Command 
import os

from aiogram.fsm.state import StatesGroup, State
from aiogram.fsm.context import FSMContext


import app.keyboards as kb

router=Router()

# —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
@router.message(CommandStart())
async def cmd_start(message:Message):
    await message.answer(
    "üëã –ü—Ä–∏–≤–µ—Ç!\n\n"
    "–¢—ã –ø–æ–ø–∞–ª –≤ Eco-Scan ‚Äî –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–º —Å—Ç—Ä–æ–∏—Ç—å —ç–∫–æ–ª–æ–≥–∏—á–Ω–æ–µ –±—É–¥—É—â–µ–µ üåç‚ôªÔ∏è.\n\n"
    "üìå –ù–∞—à–∞ —Ü–µ–ª—å ‚Äî —Å–æ–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –º—É—Å–æ—Ä–∞, —á—Ç–æ–±—ã –æ–±—É—á–∏—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç—å —Ä–∞–∑–ª–∏—á–∞—Ç—å –æ—Ç—Ö–æ–¥—ã –∏ –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å, –∫–∞–∫ –∏—Ö –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å.\n\n"
    "üì∏ –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å?\n"
    "1Ô∏è‚É£ –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ üì∑¬ª.\n"
    "2Ô∏è‚É£ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ –º—É—Å–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π —É —Ç–µ–±—è –ø–æ–¥ —Ä—É–∫–æ–π: –±—É—Ç—ã–ª–∫–∏ üçºü•§, –ø–∞—á–∫–∏ –æ—Ç —Å–ª–∞–¥–æ—Å—Ç–µ–π üç´, —Å—Ç–∞–∫–∞–Ω—á–∏–∫–∏ ‚òï, –ø–∞–∫–µ—Ç—ã –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ ‚ôªÔ∏è.\n"
    "3Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –≤ —á–∞—Ç ‚Äî –∏ —Ç—ã –≤–Ω–µ—Å—ë—à—å —Å–≤–æ–π –≤–∫–ª–∞–¥ –≤ –Ω–∞—à –¥–∞—Ç–∞—Å–µ—Ç.\n\n"
    "‚ú® –ö–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–º —Å–¥–µ–ª–∞—Ç—å –º–∏—Ä —á–∏—â–µ.\n"
    "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –Ω–∞–º üíö!",
                        reply_markup=kb.main_kb)
    
@router.message(F.text == kb.CALLBACK_BUTTON_ABOUT)
async def get_info(message:Message):
    await message.answer(
        'üåç –ú—ã ‚Äî —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞, —Ä–∞–±–æ—Ç–∞—é—â–∞—è –Ω–∞–¥ —ç–∫–æ–ª–æ–≥–∏—á–Ω—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º Eco Scan.\n'
        '–ù–∞—à–∞ —Ü–µ–ª—å ‚Äî –Ω–∞—É—á–∏—Ç—å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –æ—Ç—Ö–æ–¥—ã –∏ –ø–æ–º–æ—á—å –ª—é–¥—è–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º—É—Å–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚ôªÔ∏è.\n'
        '–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?\n\n'
        '‚ú® –°–µ–≥–æ–¥–Ω—è –æ–≥—Ä–æ–º–Ω–∞—è —á–∞—Å—Ç—å –æ—Ç—Ö–æ–¥–æ–≤ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–≤–∞–ª–∫–∞—Ö –∏ –∑–∞–≥—Ä—è–∑–Ω—è–µ—Ç –ø—Ä–∏—Ä–æ–¥—É.\n'
        '‚ú® –ú–Ω–æ–≥–∏–µ –ª—é–¥–∏ –Ω–µ –∑–Ω–∞—é—Ç, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º—É—Å–æ—Ä, –∏ –Ω—É–∂–¥–∞—é—Ç—Å—è –≤ –ø—Ä–æ—Å—Ç–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ-–ø–æ–º–æ—â–Ω–∏–∫–µ.\n'
        '‚ú® –ú—ã –≤–µ—Ä–∏–º, —á—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –º–æ–≥—É—Ç —Å—Ç–∞—Ç—å —Å–æ—é–∑–Ω–∏–∫–æ–º —ç–∫–æ–ª–æ–≥–∏–∏ üå±.\n\n'
        'üì∏ –ö–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞, –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –¥–∞—Ç–∞—Å–µ—Ç –∏ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–º –æ–±—É—á–∞—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç—å.\n'
        '–ß–µ–º –±–æ–ª—å—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚Äî —Ç–µ–º —É–º–Ω–µ–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º–æ–¥–µ–ª—å, —Ç–µ–º —Ç–æ—á–Ω–µ–µ –æ–Ω–∞ —Å–º–æ–∂–µ—Ç –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å, –∫—É–¥–∞ –≤—ã–±—Ä–æ—Å–∏—Ç—å –±—É—Ç—ã–ª–∫—É, —Å—Ç–∞–∫–∞–Ω –∏–ª–∏ –±—É–º–∞–≥—É.\n\n'
        '–í–∞—à –≤–∫–ª–∞–¥ = —á–∏—â–µ –ø–ª–∞–Ω–µ—Ç–∞ üíö.\n\n'
        '–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—ã –≤–º–µ—Å—Ç–µ —Å –Ω–∞–º–∏ —Å–æ–∑–¥–∞—ë—Ç–µ –±—É–¥—É—â–µ–µ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –º—É—Å–æ—Ä–∞ üåç‚ú®.\n'
        )


@router.message(F.text == kb.CALLBACK_BUTTON_HELP)
async def get_info(message:Message):
    await message.answer(
    "üì∏ –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:\n"
    "1Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ üì∑¬ª.\n"
    "2Ô∏è‚É£ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª—é–±–æ–≥–æ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –º—É—Å–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —É –≤–∞—Å –µ—Å—Ç—å –ø–æ–¥ —Ä—É–∫–æ–π:\n\n"
    "   ‚Ä¢ –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ –±—É—Ç—ã–ª–∫–∏ üçºü•§,\n"
    "   ‚Ä¢ –ø–∞—á–∫–∏ –æ—Ç —Å–ª–∞–¥–æ—Å—Ç–µ–π üç´,\n"
    "   ‚Ä¢ —Å—Ç–∞–∫–∞–Ω—á–∏–∫–∏ ‚òï,\n"
    "   ‚Ä¢ –±—É–º–∞–∂–∫–∏, –ø–∞–∫–µ—Ç—ã –∏ –¥—Ä—É–≥–æ–µ ‚ôªÔ∏è.\n\n"
    '3Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –≤ —á–∞—Ç ‚Äî –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –µ–≥–æ –≤ –Ω–∞—à –¥–∞—Ç–∞—Å–µ—Ç.\n\n'
    "–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?\n"
    "‚ú® –ß–µ–º –±–æ–ª—å—à–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ç–æ, —Ç–µ–º –ª—É—á—à–µ –æ–±—É—á–∞–µ—Ç—Å—è –Ω–∞—à–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç—å.\n"
    "‚ú® –î–∞–∂–µ –æ–¥–Ω–æ –≤–∞—à–µ —Ñ–æ—Ç–æ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –Ω–∞—Å –∫ —Ç–æ–º—É, —á—Ç–æ–±—ã –±–æ—Ç –≤ –±—É–¥—É—â–µ–º —Å–∞–º –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–ª, –∫—É–¥–∞ –≤—ã–±—Ä–æ—Å–∏—Ç—å —Ç–æ—Ç –∏–ª–∏ –∏–Ω–æ–π –ø—Ä–µ–¥–º–µ—Ç.\n\n"
    "üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ —Ç–∞–∫, —á—Ç–æ–±—ã –ø—Ä–µ–¥–º–µ—Ç –±—ã–ª —Ö–æ—Ä–æ—à–æ –≤–∏–¥–µ–Ω, –Ω–æ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–¥–µ–∞–ª—å–Ω–æ ‚Äî –Ω–∞–º –Ω—É–∂–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ —Å–Ω–∏–º–∫–∏ –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏.\n\n"
    "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç–µ –Ω–∞–º —Å—Ç—Ä–æ–∏—Ç—å —ç–∫–æ–ª–æ–≥–∏—á–Ω–æ–µ –±—É–¥—É—â–µ–µ üåçüíö!"
    )

@router.message(F.text == kb.CALLBACK_BUTTON_SEND)
async def send_phot(message: Message):
    await message.answer('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π üì∏',
                        reply_markup=kb.recycling_kb)
    
@router.message(F.text == '–ù–∞–∑–∞–¥')
async def exit_kb(message: Message):
    await message.answer('–í—ã—Ö–æ–¥ ‚¨ÖÔ∏è',
                        reply_markup=kb.main_kb)

class DataForm(StatesGroup):
    waiting_photo = State()

async def ask_for_photo(message: Message, state: FSMContext, category: str):
    await  message.answer("–ú–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞—à–µ —Ñ–æ—Ç–æ üòá",
                        reply_markup = kb.recycling_all)
    await state.update_data(category=category)
    await state.set_state(DataForm.waiting_photo)

async def ask_for_trash_photo(message: Message, state: FSMContext, category: str):
    await  message.answer("–ú–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞—à–µ —Ñ–æ—Ç–æ üòá",
                        reply_markup = kb.recycling_trash_all)
    await state.update_data(category=category)
    await state.set_state(DataForm.waiting_photo)

@router.message(F.text == kb.CALLBACK_BUTTON_PLASTIC)
async def plastic_handler(message: Message, state: FSMContext):
    await ask_for_photo(message, state, "plastic")

@router.message(F.text == kb.CALLBACK_BUTTON_GLASS)
async def glass_handler(message: Message, state: FSMContext):
    await ask_for_photo(message, state, "glass")

@router.message(F.text == kb.CALLBACK_BUTTON_PAPER)
async def paper_handler(message:Message, state: FSMContext):
    await ask_for_photo(message, state, "paper")

#–ø–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –º—É—Å–æ—Ä–∞
@router.message(F.text == kb.CALLBACK_BUTTON_ALL)
async def trash_handler(message:Message, state: FSMContext):
    # await message.answer('–ú–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞—à–µ —Ñ–æ—Ç–æ üòá')
    await ask_for_trash_photo(message, state, "trash")

@router.message(F.photo, DataForm.waiting_photo)
async def save_photo(message:Message, state: FSMContext):
    data = await state.get_data()
    category = data.get("category", "other")
    photo = message.photo[-1]
    safe_id = photo.file_unique_id.strip('-')
    base_dir = os.path.join(os.path.dirname(__file__), "..", "photos", category)
    file_name = os.path.join(base_dir, f"{message.from_user.id}_{safe_id}.jpg")
    file = await message.bot.get_file(photo.file_id)
    await message.bot.download_file(file.file_path, destination=file_name)
    await message.answer('–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ, —Å–ø–∞—Å–∏–±–æ üíö!')
    await state.clear()

@router.message(F.text == kb.CALLBACK_BUTTON_BACK)
async def exit_kb(message: Message):
    await message.answer(kb.CALLBACK_BUTTON_BACK,
                        reply_markup=kb.recycling_kb)
    
@router.message(F.text == kb.CALLBACK_BUTTON_ALL_WHAT)
async def tell_info(message: Message):
    await message.answer(
        'üåç‚ôª –ß—Ç–æ –Ω–µ–ª—å–∑—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–¥–∞–≤–∞—Ç—å –Ω–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É?\n'
        '–ï—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –æ–±—â–µ–º—É –º—É—Å–æ—Ä—É –∏ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –Ω–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É:\n\n'
        'üö´ –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã:\n'
        '   ‚Ä¢–ó–µ—Ä–∫–∞–ª–∞ –∏ —Å—Ç–µ–∫–ª—è–Ω–Ω–∞—è –ø–æ—Å—É–¥–∞ (–∏–º–µ—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–æ–∫—Ä—ã—Ç–∏—è –∏ –ø—Ä–∏–º–µ—Å–∏).\n'
        '   ‚Ä¢–ü–µ–Ω–æ–ø–ª–∞—Å—Ç –∏ –ø–µ–Ω–æ–ø–æ–ª–∏—Å—Ç–∏—Ä–æ–ª (–æ—á–µ–Ω—å —Ç—Ä—É–¥–Ω–æ –ø–µ—Ä–µ—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è).\n'
        '   ‚Ä¢–û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –ø–æ—Å—É–¥–∞ —Å –∂–∏—Ä–æ–≤—ã–º–∏/–ø–∏—â–µ–≤—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏.\n'
        '   ‚Ä¢–§–∞—Ä—Ñ–æ—Ä, –∫–µ—Ä–∞–º–∏–∫–∞ –∏ —Ç–µ—Ä–º–æ—Å—Ç–æ–π–∫–æ–µ —Å—Ç–µ–∫–ª–æ.\n'
        '   ‚Ä¢–ì—Ä—è–∑–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –æ—Ç –º–æ–ª–æ–∫–∞/–∫–µ—Ñ–∏—Ä–∞, —Ç–µ—Ç—Ä–∞–ø–∞–∫ –±–µ–∑ –ø—Ä–æ–º—ã–≤–∫–∏.\n'
        '   ‚Ä¢–°—Ä–µ–¥—Å—Ç–≤–∞ –ª–∏—á–Ω–æ–π –≥–∏–≥–∏–µ–Ω—ã (–º–∞—Å–∫–∏, –ø–µ—Ä—á–∞—Ç–∫–∏, –≤–∞—Ç–Ω—ã–µ –ø–∞–ª–æ—á–∫–∏, –ø–æ–¥–≥—É–∑–Ω–∏–∫–∏).\n\n'
        '‚ùó–¢–∞–∫–∏–µ –≤–µ—â–∏ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –ø—É–Ω–∫—Ç—ã –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –∏ –∏—Ö –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –≤ –æ–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.\n'
    )
    
